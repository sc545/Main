import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.HashMap;


public class Server {

	public static void main(String[] args) throws Exception {
		int PORT = 1113;
		int TIMES = 100;
		HashMap<String, Integer> rank = new HashMap<String, Integer>();
		ServerSocket ss = new ServerSocket(PORT);
		int i = 1;
		while(i <= TIMES){
			int result = 0;
			System.out.println("소켓 활성화!!");
			Socket s = ss.accept();
			System.out.println("소켓 연결!!");
			OutputStream os = s.getOutputStream();
			ObjectOutputStream oos = new ObjectOutputStream(os);
			InputStream is = s.getInputStream();
			ObjectInputStream ois = new ObjectInputStream(is);
			
			String flag = (String) ois.readObject();
			
			Connection connect=null;
			Statement st=null;
			ResultSet rs=null;
			try{
				Class.forName("com.mysql.jdbc.Driver");
			}catch(ClassNotFoundException ce){
				System.out.println(ce);
				System.out.println("클래스 로드 불가");
			}
			
			try{
				connect = DriverManager.getConnection("jdbc:mysql://localhost:3306/Alltogether","Alltogether", "");					
				
				st = connect.createStatement();
				rs = st.executeQuery("select * from rank order by score");
				while(rs.next()){
					rank.put(rs.getString("name"), rs.getInt("score"));
					System.out.println(rs.getString("name") +" "+ rs.getInt("score"));
				}
				
				if(flag.equals("read")){
					oos.writeObject(rank);
				}
				if(flag.equals("write")){
					String name = (String) ois.readObject();
					int score = (int) ois.readObject();
					st.executeUpdate("insert into rank values ('"+name+"', "+score+")");
					System.out.println("등록완료");
				}
				
				if(rs!=null)rs.close();
				if(st!=null)st.close();
				if(connect!=null)connect.close();
				
			}catch(SQLException se){
				System.out.println(s);
			}
			
			s.close();
			
		}
		ss.close();
		
	}

}
